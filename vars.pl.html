<pre>
   1 <span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
   3 <span class="k">use</span> <span class="w">Irssi::TextUI</span><span class="sc">;</span>
   4 
   5     <span class="k">use</span> <span class="w">Storable</span><span class="sc">;</span>
   6     <span class="k">our</span> <span class="s">(</span><span class="i">%config</span><span class="cm">,</span> <span class="i">%foo</span><span class="cm">,</span> <span class="i">$farg</span><span class="cm">,</span> <span class="i">$sarg</span><span class="cm">,</span> <span class="i">@varcmds</span><span class="cm">,</span> <span class="i">@tabcmds</span><span class="cm">,</span> <span class="i">@undo</span><span class="cm">,</span> <span class="i">@redo</span><span class="s">)</span><span class="sc">;</span>
   7     <span class="k">my</span> <span class="i">$hashref</span><span class="sc">;</span>
   8     
   9     <span class="k">my</span> <span class="i">$user</span> = <span class="k">getpwuid</span><span class="s">(</span><span class="i">$&lt;</span><span class="s">)</span><span class="sc">;</span>
  10     <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>} = <span class="q">&#39;/home/&#39;</span> . <span class="i">$user</span> . <span class="q">&#39;/.irssi/&#39;</span><span class="sc">;</span>
  11     <span class="k">mkdir</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>} <span class="k">unless</span> <span class="k">-e</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}<span class="sc">;</span>
  12     
  13     <span class="c">#move .vardata to its new home if it exists</span>
  14     <span class="k">use</span> <span class="w">File::Copy</span><span class="sc">;</span>
  15     <span class="k">use</span> <span class="w">File::Path</span><span class="sc">;</span>
  16     <span class="i">move</span><span class="s">(</span><span class="q">&#39;/home/&#39;</span> . <span class="i">$user</span> . <span class="q">&#39;/.vardata&#39;</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>} . <span class="q">&#39;.vardata&#39;</span><span class="s">)</span> <span class="k">if</span> <span class="k">-e</span> <span class="q">&#39;/home/&#39;</span> . <span class="i">$user</span> . <span class="q">&#39;.vardata&#39;</span><span class="sc">;</span>
  17     <span class="i">move</span><span class="s">(</span><span class="q">&#39;/home/&#39;</span> . <span class="i">$user</span> . <span class="q">&#39;/.irssi/scripts/varspl/.vardata&#39;</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>} . <span class="q">&#39;.vardata&#39;</span><span class="s">)</span> <span class="k">if</span> <span class="k">-e</span> <span class="q">&#39;/home/&#39;</span> . <span class="i">$user</span> . <span class="q">&#39;/.irssi/scripts/varspl/.vardata&#39;</span><span class="sc">;</span>
  18     <span class="i">File::Path::rmtree</span><span class="s">(</span><span class="q">&#39;/home/&#39;</span> . <span class="i">$user</span> . <span class="q">&#39;/.irssi/scripts/varspl&#39;</span><span class="s">)</span><span class="sc">;</span>
  19 
  20     <span class="k">if</span><span class="s">(</span><span class="k">-e</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span> <span class="s">{</span>
  21         <span class="s">(</span><span class="s">(</span><span class="i">$hashref</span> = <span class="i">retrieve</span><span class="s">(</span><span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="s">)</span> &amp;&amp; <span class="s">(</span><span class="i">%foo</span> = <span class="i">%</span>{<span class="i">$hashref</span>}<span class="s">)</span><span class="s">)</span><span class="sc">;</span>
  22         
  23         <span class="c">#backwards compatibility - replace spaces in variable names with _</span>
  24         <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="k">sort</span> <span class="k">keys</span> <span class="i">%foo</span><span class="s">)</span> <span class="s">{</span>
  25             <span class="k">my</span> <span class="i">$old</span> = <span class="i">$key</span><span class="sc">;</span>
  26             <span class="k">if</span><span class="s">(</span><span class="i">$key</span> =~ <span class="q">s/\s/_/g</span><span class="s">)</span> <span class="s">{</span>
  27                 <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;WARNING: Variable &#39;$old&#39; renamed to &#39;$key&#39;, since spaces are no longer permitted in variable names.&quot;</span><span class="s">)</span><span class="sc">;</span>
  28                 <span class="i">$foo</span>{<span class="i">$key</span>} = <span class="i">$foo</span>{<span class="i">$old</span>}<span class="sc">;</span>
  29                 <span class="k">delete</span> <span class="i">$foo</span>{<span class="i">$old</span>} &amp;&amp; <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span>
  30             <span class="s">}</span>
  31         <span class="s">}</span>
  32     <span class="s">}</span>
  33     
  34 <span class="i">@varcmds</span> = <span class="s">(</span><span class="q">&#39;mkvar&#39;</span><span class="cm">,</span> <span class="q">&#39;rmvar&#39;</span><span class="cm">,</span> <span class="q">&#39;varlist&#39;</span><span class="cm">,</span> <span class="q">&#39;varhelp&#39;</span><span class="cm">,</span> <span class="q">&#39;undo&#39;</span><span class="cm">,</span> <span class="q">&#39;redo&#39;</span><span class="cm">,</span> <span class="q">&#39;editvar&#39;</span><span class="cm">,</span> <span class="q">&#39;cpvar&#39;</span><span class="s">)</span><span class="sc">;</span>
  35 <span class="i">@tabcmds</span> = <span class="s">(</span><span class="q">&#39;mkvar&#39;</span><span class="cm">,</span> <span class="q">&#39;rmvar&#39;</span><span class="cm">,</span> <span class="q">&#39;editvar&#39;</span><span class="cm">,</span> <span class="q">&#39;cpvar&#39;</span><span class="s">)</span><span class="sc">;</span>
  36 <span class="k">our</span> <span class="i">$build</span> = <span class="k">join</span><span class="s">(</span><span class="q">&#39;|&#39;</span><span class="cm">,</span> <span class="i">@tabcmds</span><span class="s">)</span><span class="sc">;</span>
  37 
<a name="stack_gen"></a>  38 <span class="k">sub </span><span class="m">stack_gen</span> <span class="s">{</span>
  39     <span class="k">my</span><span class="s">(</span><span class="i">$undoCode</span><span class="cm">,</span> <span class="i">$undoText</span><span class="cm">,</span> <span class="i">$redoCode</span><span class="cm">,</span> <span class="i">$redoText</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  40 
  41     <span class="c">#first things first... since new action happening, clear redo buffer.</span>
  42     <span class="i">@redo</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  43 
  44     <span class="k">my</span> <span class="i">$ref</span> = <span class="s">[</span><span class="s">[</span><span class="i">$undoCode</span><span class="cm">,</span> <span class="i">$undoText</span><span class="s">]</span><span class="cm">,</span> <span class="s">[</span><span class="i">$redoCode</span><span class="cm">,</span> <span class="i">$redoText</span><span class="s">]</span><span class="s">]</span><span class="sc">;</span>
  45     <span class="k">push</span><span class="s">(</span><span class="i">@undo</span><span class="cm">,</span> <span class="i">$ref</span><span class="s">)</span><span class="sc">;</span>
  46 <span class="s">}</span><span class="c">#build undo and redo stack</span>
  47 
<a name="tab_complete"></a>  48 <span class="k">sub </span><span class="m">tab_complete</span> <span class="s">{</span>
  49     <span class="k">my</span> <span class="i">$testre</span> = <span class="q">qr/^\/$build/</span><span class="sc">;</span> <span class="c">#only one regex to change.</span>
  50     <span class="k">my</span> <span class="s">(</span><span class="i">$strings</span><span class="cm">,</span> <span class="i">$window</span><span class="cm">,</span> <span class="i">$word</span><span class="cm">,</span> <span class="i">$linestart</span><span class="cm">,</span> <span class="i">$want_space</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  51     <span class="c">#Irssi::print(&quot;\$linestart: &#39;$linestart&#39;&quot;);</span>
  52     <span class="c">#Irssi::print(&quot;\$word: &#39;$word&#39;&quot;);</span>
  53     <span class="k">my</span> <span class="i">$post</span><span class="sc">;</span>
  54     <span class="k">my</span> <span class="i">$brace</span><span class="sc">;</span>
  55     <span class="k">my</span> <span class="i">$primed</span> = <span class="n">0</span><span class="sc">;</span>
  56     <span class="k">if</span> <span class="s">(</span><span class="i">$linestart</span> =~ <span class="q">/$testre/</span><span class="s">)</span> <span class="s">{</span>
  57         <span class="c">#Irssi::print(&#39;condition 1&#39;);</span>
  58         <span class="c">#build list of eligible words using $word.</span>
  59         <span class="i">$post</span> = <span class="i">$&#39;</span><span class="sc">;</span>
  60         <span class="c">#Irssi::print($post) if $post;</span>
  61         <span class="k">return</span> <span class="k">unless</span><span class="s">(</span><span class="s">(</span>!<span class="i">$post</span> &amp;&amp; <span class="i">$word</span> !~ <span class="q">/\W/</span><span class="s">)</span>
  62           ||<span class="s">(</span><span class="s">(</span><span class="i">$post</span> &amp;&amp; <span class="i">$word</span> =~ <span class="q">/\{\{((\w+)((?!\\\}\})|(?!\}\})))?$/</span><span class="s">)</span> 
  63           &amp;&amp; <span class="k">eval</span> <span class="s">{</span><span class="i">$brace</span> = <span class="n">1</span><span class="sc">;</span> <span class="k">return</span> <span class="n">1</span><span class="s">}</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
  64           <span class="c">#Irssi::print(&quot;still alive!&quot;);</span>
  65     <span class="s">}</span>
  66     <span class="k">elsif</span><span class="s">(</span><span class="i">$word</span> =~ <span class="q">/\{\{((\w+)((?!\\\}\})|(?!\}\})))?$/</span><span class="s">)</span> <span class="s">{</span>
  67         <span class="c">#Irssi::print(&#39;condition 2&#39;);</span>
  68         <span class="i">$brace</span> = <span class="n">1</span><span class="sc">;</span>
  69     <span class="s">}</span>
  70     <span class="k">else</span> <span class="s">{</span>
  71         <span class="i">@$strings</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  72         <span class="k">return</span><span class="sc">;</span>
  73     <span class="s">}</span>
  74 
  75     <span class="i">@$strings</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span> <span class="c">#clear out any old rubbish that may be lingering</span>
  76     <span class="k">my</span> <span class="i">$pre</span> = <span class="q">&#39;&#39;</span><span class="sc">;</span>
  77     <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="k">sort</span> <span class="s">{</span> <span class="k">lc</span><span class="s">(</span><span class="i">$a</span><span class="s">)</span> <span class="k">cmp</span> <span class="k">lc</span><span class="s">(</span><span class="i">$b</span><span class="s">)</span> <span class="s">}</span> <span class="k">keys</span> <span class="i">%foo</span><span class="s">)</span> <span class="s">{</span>
  78         <span class="i">$word</span> =~ <span class="q">s/(.*)\{\{//</span> <span class="k">if</span> <span class="i">$brace</span><span class="sc">;</span>
  79         <span class="i">$pre</span> = <span class="i">$1</span> <span class="k">if</span> <span class="s">(</span><span class="i">$1</span> <span class="k">and</span> <span class="i">$brace</span><span class="s">)</span><span class="sc">;</span> 
  80         <span class="c">#Irssi::print(&quot;\$word: &#39;$word&#39;&quot;);</span>
  81         <span class="c">#get all the stuff in front of {{ just in case</span>
  82         <span class="c">#Irssi::print(&quot;pre: &#39;$pre&#39;&quot;);</span>
  83         <span class="k">if</span><span class="s">(</span><span class="i">$key</span> =~ <span class="q">/^$word/i</span><span class="s">)</span> <span class="s">{</span>
  84             <span class="k">push</span><span class="s">(</span><span class="i">@$strings</span><span class="cm">,</span>
  85                 <span class="s">(</span><span class="i">$pre</span>   ? <span class="i">$pre</span> <span class="co">:</span> <span class="q">&#39;&#39;</span><span class="s">)</span> .
  86                 <span class="s">(</span><span class="i">$brace</span> ? <span class="q">&#39;{{&#39;</span>.<span class="i">$key</span>.<span class="q">&#39;}}&#39;</span>
  87                        <span class="co">:</span> <span class="i">$key</span><span class="s">)</span>
  88             <span class="s">)</span><span class="sc">;</span>
  89         <span class="s">}</span>
  90     <span class="s">}</span>
  91     <span class="i">$$want_space</span> = <span class="n">0</span><span class="sc">;</span>
  92     <span class="w">Irssi::signal_stop</span><span class="sc">;</span>
  93 <span class="s">}</span>      
  94 
<a name="cmd_mkvar"></a>  95 <span class="k">sub </span><span class="m">cmd_mkvar</span> <span class="s">{</span>
  96     <span class="k">my</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  97     <span class="i">$_</span> = <span class="i">$data</span><span class="sc">;</span>
  98 
  99     <span class="k">my</span> <span class="i">@args</span> = <span class="k">split</span><span class="s">(</span><span class="q">/\s/</span><span class="s">)</span><span class="sc">;</span>
 100     <span class="k">if</span><span class="s">(</span><span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> &lt; <span class="n">2</span><span class="s">)</span> <span class="s">{</span>
 101         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Syntax Error: &#39;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> == <span class="n">1</span> ? <span class="q">&#39;Single&#39;</span> <span class="co">:</span> <span class="q">&#39;No&#39;</span> . <span class="q">&#39; Argument Given&#39;</span><span class="s">)</span><span class="sc">;</span>
 102         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Type &quot;/help vars mkvar&quot;  for command usage&#39;</span><span class="s">)</span><span class="sc">;</span>
 103         <span class="k">return</span><span class="sc">;</span>
 104     <span class="s">}</span>
 105     <span class="k">else</span> <span class="s">{</span>
 106         <span class="i">$farg</span> = <span class="k">shift</span> <span class="i">@args</span><span class="sc">;</span>
 107         <span class="i">$sarg</span> = <span class="k">join</span><span class="s">(</span><span class="q">&#39; &#39;</span><span class="cm">,</span> <span class="i">@args</span><span class="s">)</span><span class="sc">;</span>
 108         <span class="k">if</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$farg</span>}<span class="s">)</span> <span class="s">{</span>
 109             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Error: variable &#39;$farg&#39; already exists. Use /editvar to overwrite&quot;</span><span class="s">)</span><span class="sc">;</span>
 110             <span class="k">return</span><span class="sc">;</span>
 111         <span class="s">}</span>
 112         <span class="k">if</span><span class="s">(</span><span class="i">$farg</span> =~ <span class="q">/\W/</span><span class="s">)</span> <span class="s">{</span>
 113             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Error: only alphanumeric characters (A-Z, a-z, 0-9 and _) are permitted in variable names.&#39;</span><span class="s">)</span><span class="sc">;</span>
 114             <span class="k">return</span><span class="sc">;</span>
 115         <span class="s">}</span>
 116     <span class="s">}</span>
 117 
 118     <span class="k">while</span><span class="s">(</span><span class="i">$sarg</span> =~ <span class="q">/\G(?!\\)\{\{(\w+)(?!\\)\}\}/g</span><span class="s">)</span> <span class="s">{</span>
 119         <span class="k">my</span> <span class="i">$match</span> = <span class="i">$1</span><span class="sc">;</span>
 120         <span class="k">unless</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$match</span>}<span class="s">)</span> <span class="s">{</span>
 121             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Inserted variable \&#39;{{&#39;</span> . <span class="i">$match</span> . <span class="q">&#39;}}\&#39; does not exist. Remember to backlslash (\{{ \}}) any variables you do not want interpreted. Command failed.&#39;</span><span class="s">)</span><span class="sc">;</span>
 122             <span class="k">return</span><span class="sc">;</span>
 123         <span class="s">}</span>
 124     <span class="s">}</span>
 125     <span class="k">my</span> <span class="i">$safe</span> = <span class="i">loopcheck</span><span class="s">(</span><span class="i">$sarg</span><span class="s">)</span><span class="sc">;</span>
 126     <span class="k">if</span><span class="s">(</span><span class="i">$safe</span> <span class="k">eq</span> <span class="q">&#39;ERROR&#39;</span><span class="s">)</span> <span class="s">{</span>
 127         <span class="k">return</span><span class="sc">;</span>
 128     <span class="s">}</span>
 129     <span class="k">else</span> <span class="s">{</span>
 130         <span class="i">$foo</span>{<span class="i">$farg</span>} = <span class="i">$sarg</span><span class="sc">;</span>
 131         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Variable &#39;$farg&#39; succesfully saved with value &#39;$sarg&#39;&quot;</span><span class="s">)</span><span class="sc">;</span>
 132         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 133         
 134         <span class="c">#build undo and redo stack</span>
 135         <span class="k">my</span> <span class="i">$undoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 136                         <span class="k">delete</span> <span class="i">$foo</span>{<span class="i">$farg</span>}<span class="sc">;</span>
 137                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 138                       <span class="s">}</span><span class="sc">;</span>
 139         <span class="k">my</span> <span class="i">$redoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 140                         <span class="i">$foo</span>{<span class="i">$farg</span>} = <span class="i">$sarg</span><span class="sc">;</span>
 141                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 142                       <span class="s">}</span><span class="sc">;</span>
 143         <span class="k">my</span> <span class="i">$undoTxt</span> = <span class="q">&quot;Deleted variable &#39;$farg&#39; containing value: &#39;$sarg&#39;&quot;</span><span class="sc">;</span>
 144         <span class="k">my</span> <span class="i">$redoTxt</span> = <span class="q">&quot;Recreated variable &#39;$farg&#39; containing value: &#39;$sarg&#39;&quot;</span><span class="sc">;</span>
 145 
 146         <span class="i">stack_gen</span><span class="s">(</span><span class="i">$undoRef</span><span class="cm">,</span> <span class="i">$undoTxt</span><span class="cm">,</span> <span class="i">$redoRef</span><span class="cm">,</span> <span class="i">$redoTxt</span><span class="s">)</span><span class="sc">;</span>
 147     <span class="s">}</span>
 148     <span class="k">return</span><span class="sc">;</span>
 149 <span class="s">}</span>
 150 
<a name="cmd_rmvar"></a> 151 <span class="k">sub </span><span class="m">cmd_rmvar</span> <span class="s">{</span>
 152     <span class="k">my</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 153     <span class="k">my</span> <span class="i">$tmp</span> = <span class="i">$foo</span>{<span class="i">$data</span>}<span class="sc">;</span>
 154     <span class="k">if</span><span class="s">(</span><span class="k">delete</span> <span class="i">$foo</span>{<span class="i">$data</span>} &amp;&amp; <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
 155         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Variable &#39;$data&#39; has been successfully deleted&quot;</span><span class="s">)</span><span class="sc">;</span>
 156 
 157         <span class="c">#build undo and redo stack</span>
 158         <span class="k">my</span> <span class="i">$undoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 159                         <span class="i">$foo</span>{<span class="i">$data</span>} = <span class="i">$tmp</span><span class="sc">;</span>
 160                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 161                       <span class="s">}</span><span class="sc">;</span>
 162         <span class="k">my</span> <span class="i">$redoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 163                         <span class="k">delete</span> <span class="i">$foo</span>{<span class="i">$data</span>}<span class="sc">;</span>
 164                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 165                       <span class="s">}</span><span class="sc">;</span>
 166         <span class="k">my</span> <span class="i">$undoTxt</span> = <span class="q">&quot;Deleted variable &#39;$data&#39; restored with value &#39;$tmp&#39;.&quot;</span><span class="sc">;</span>
 167         <span class="k">my</span> <span class="i">$redoTxt</span> = <span class="q">&quot;Variable &#39;$data&#39; deleted again.&quot;</span><span class="sc">;</span>
 168 
 169         <span class="i">stack_gen</span><span class="s">(</span><span class="i">$undoRef</span><span class="cm">,</span> <span class="i">$undoTxt</span><span class="cm">,</span> <span class="i">$redoRef</span><span class="cm">,</span> <span class="i">$redoTxt</span><span class="s">)</span><span class="sc">;</span>
 170     <span class="s">}</span>
 171     <span class="k">else</span> <span class="s">{</span>
 172         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Variable &#39;$data&#39; not found&quot;</span><span class="s">)</span><span class="sc">;</span>
 173     <span class="s">}</span>
 174     <span class="k">return</span><span class="sc">;</span>
 175 <span class="s">}</span>
 176 
<a name="cmd_editvar"></a> 177 <span class="k">sub </span><span class="m">cmd_editvar</span> <span class="s">{</span>
 178     <span class="k">my</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 179     <span class="i">$_</span> = <span class="i">$data</span><span class="sc">;</span>
 180 
 181     <span class="k">my</span> <span class="i">@args</span> = <span class="k">split</span><span class="s">(</span><span class="q">/\s/</span><span class="s">)</span><span class="sc">;</span>
 182     <span class="k">if</span><span class="s">(</span><span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> &lt; <span class="n">2</span><span class="s">)</span> <span class="s">{</span>
 183         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Syntax Error: &#39;</span> . <span class="s">(</span><span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> == <span class="n">1</span> ? <span class="q">&#39;Single&#39;</span> <span class="co">:</span> <span class="q">&#39;No&#39;</span><span class="s">)</span> . <span class="q">&#39; argument given.&#39;</span><span class="s">)</span><span class="sc">;</span>
 184         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Type &quot;/help vars editvar&quot; for command usage&#39;</span><span class="s">)</span><span class="sc">;</span>
 185         <span class="k">return</span><span class="sc">;</span>
 186     <span class="s">}</span>
 187     <span class="k">else</span> <span class="s">{</span>
 188         <span class="i">$farg</span> = <span class="k">shift</span> <span class="i">@args</span><span class="sc">;</span>
 189         <span class="i">$sarg</span> = <span class="k">join</span><span class="s">(</span><span class="q">&#39; &#39;</span><span class="cm">,</span> <span class="i">@args</span><span class="s">)</span><span class="sc">;</span>
 190         <span class="k">if</span><span class="s">(</span>!<span class="i">$foo</span>{<span class="i">$farg</span>}<span class="s">)</span> <span class="s">{</span>
 191             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Error: variable &#39;$farg&#39; does not exist. Use /mkvar to create a new variable.&quot;</span><span class="s">)</span><span class="sc">;</span>
 192             <span class="k">return</span><span class="sc">;</span>
 193         <span class="s">}</span>
 194     <span class="s">}</span>
 195 
 196     <span class="k">while</span><span class="s">(</span><span class="i">$sarg</span> =~ <span class="q">/\G(?!\\)\{\{(\w+)(?!\\)\}\}/g</span><span class="s">)</span> <span class="s">{</span>
 197         <span class="k">my</span> <span class="i">$match</span> = <span class="i">$1</span><span class="sc">;</span>
 198         <span class="k">unless</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$match</span>}<span class="s">)</span> <span class="s">{</span>
 199             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Inserted variable \&#39;{{&#39;</span> . <span class="i">$match</span> . <span class="q">&#39;}}\&#39; does not exist. Remember to backlslash (\{{ \}}) any variables you do not want interpreted. Command failed.&#39;</span><span class="s">)</span><span class="sc">;</span>
 200             <span class="k">return</span><span class="sc">;</span>
 201         <span class="s">}</span>
 202     <span class="s">}</span>
 203     <span class="k">my</span> <span class="i">$tmp</span> = <span class="i">$foo</span>{<span class="i">$farg</span>}<span class="sc">;</span>
 204     <span class="i">$foo</span>{<span class="i">$farg</span>} = <span class="i">$sarg</span><span class="sc">;</span>
 205     <span class="k">my</span> <span class="i">$safe</span> = <span class="i">loopcheck</span><span class="s">(</span><span class="i">$sarg</span><span class="s">)</span><span class="sc">;</span>
 206     <span class="k">if</span><span class="s">(</span><span class="i">$safe</span> <span class="k">eq</span> <span class="q">&#39;ERROR&#39;</span><span class="s">)</span> <span class="s">{</span>
 207         <span class="i">$foo</span>{<span class="i">$farg</span>} = <span class="i">$tmp</span><span class="sc">;</span>
 208         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Definition of \&#39;&#39;</span> . <span class="i">$farg</span> . <span class="q">&#39;\&#39; unchanged&#39;</span><span class="s">)</span><span class="sc">;</span>
 209     <span class="s">}</span>
 210     <span class="k">else</span> <span class="s">{</span>
 211         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Variable &#39;$farg&#39; succesfully saved with new value &#39;$sarg&#39;&quot;</span><span class="s">)</span><span class="sc">;</span>
 212         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 213 
 214         <span class="c">#build undo and redo stack</span>
 215         <span class="k">my</span> <span class="i">$undoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 216                         <span class="i">$foo</span>{<span class="i">$farg</span>} = <span class="i">$tmp</span><span class="sc">;</span>
 217                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 218                       <span class="s">}</span><span class="sc">;</span>
 219         <span class="k">my</span> <span class="i">$redoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 220                         <span class="i">$foo</span>{<span class="i">$farg</span>} = <span class="i">$sarg</span><span class="sc">;</span>
 221                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 222                       <span class="s">}</span><span class="sc">;</span>
 223         <span class="k">my</span> <span class="i">$undoTxt</span> = <span class="q">&quot;Value of variable &#39;$farg&#39; reverted from &#39;$sarg&#39; to &#39;$tmp&#39;.&quot;</span><span class="sc">;</span>
 224         <span class="k">my</span> <span class="i">$redoTxt</span> = <span class="q">&quot;Value of variable &#39;$farg&#39; changed again from &#39;$tmp&#39; to &#39;$sarg&#39;&quot;</span><span class="sc">;</span>
 225 
 226         <span class="i">stack_gen</span><span class="s">(</span><span class="i">$undoRef</span><span class="cm">,</span> <span class="i">$undoTxt</span><span class="cm">,</span> <span class="i">$redoRef</span><span class="cm">,</span> <span class="i">$redoTxt</span><span class="s">)</span><span class="sc">;</span>
 227     <span class="s">}</span>
 228     <span class="k">return</span><span class="sc">;</span>
 229 <span class="s">}</span>
 230 
<a name="cmd_cpvar"></a> 231 <span class="k">sub </span><span class="m">cmd_cpvar</span> <span class="s">{</span>
 232     <span class="k">my</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 233     <span class="i">$_</span> = <span class="i">$data</span><span class="sc">;</span>
 234 
 235     <span class="k">my</span> <span class="i">@args</span> = <span class="k">split</span><span class="s">(</span><span class="q">/\s/</span><span class="s">)</span><span class="sc">;</span>
 236     <span class="k">if</span><span class="s">(</span><span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> &lt; <span class="n">2</span> || <span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> &gt; <span class="n">3</span><span class="s">)</span> <span class="s">{</span>
 237         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Syntax Error: &#39;</span> . <span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> . <span class="s">(</span><span class="k">scalar</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span> == <span class="n">1</span> ? <span class="q">&#39; argument&#39;</span> <span class="co">:</span> <span class="q">&#39; arguments&#39;</span><span class="s">)</span> . <span class="q">&#39;given.&#39;</span><span class="s">)</span><span class="sc">;</span>
 238         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Type &quot;/help vars cpvar&quot; for command usage&#39;</span><span class="s">)</span><span class="sc">;</span>
 239         <span class="k">return</span><span class="sc">;</span>
 240     <span class="s">}</span>
 241 
 242     <span class="k">my</span> <span class="i">@flags</span><span class="sc">;</span>
 243     <span class="k">my</span> <span class="i">$var</span> = <span class="k">shift</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span><span class="sc">;</span>
 244     <span class="k">if</span><span class="s">(</span><span class="i">$var</span> =~ <span class="q">/-(\w+)/</span><span class="s">)</span> <span class="s">{</span>
 245         <span class="i">@flags</span> = <span class="k">split</span><span class="s">(</span><span class="q">//</span><span class="cm">,</span> <span class="i">$1</span><span class="s">)</span><span class="sc">;</span>
 246 
 247         <span class="k">my</span> <span class="i">%seen</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
 248         <span class="k">my</span> <span class="i">@r</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
 249         <span class="k">foreach</span> <span class="k">my</span> <span class="i">$a</span> <span class="s">(</span><span class="i">@flags</span><span class="s">)</span> <span class="s">{</span>
 250             <span class="k">if</span><span class="s">(</span><span class="i">$a</span> !~ <span class="q">/^[pf]$/</span><span class="s">)</span> <span class="s">{</span>
 251                 <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Error: &#39;$a&#39; is not a valid flag.&quot;</span><span class="s">)</span><span class="sc">;</span>
 252                 <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Type &quot;/help vars cpvar&quot; for command usage&#39;</span><span class="s">)</span><span class="sc">;</span>
 253                 <span class="k">return</span><span class="sc">;</span>
 254             <span class="s">}</span>
 255             <span class="k">unless</span> <span class="s">(</span><span class="i">$seen</span>{<span class="i">$a</span>} || <span class="i">$a</span> !~ <span class="q">/^[pf]$/</span><span class="s">)</span> <span class="s">{</span>
 256                 <span class="k">push</span> <span class="i">@r</span><span class="cm">,</span> <span class="i">$a</span><span class="sc">;</span>
 257                 <span class="i">$seen</span>{<span class="i">$a</span>} = <span class="n">1</span><span class="sc">;</span>
 258             <span class="s">}</span>
 259         <span class="s">}</span>
 260         <span class="i">@flags</span> = <span class="i">@r</span><span class="sc">;</span>
 261         <span class="i">@flags</span> = <span class="k">sort</span><span class="s">(</span><span class="i">@flags</span><span class="s">)</span><span class="sc">;</span>
 262         
 263         <span class="i">$var</span> = <span class="k">shift</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span><span class="sc">;</span>
 264     <span class="s">}</span>
 265     <span class="k">elsif</span><span class="s">(</span><span class="i">$var</span> =~ <span class="q">/\W/</span><span class="s">)</span> <span class="s">{</span>
 266         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Error: &#39;$var&#39; is not a valid flag or variable name.&quot;</span><span class="s">)</span><span class="sc">;</span>
 267         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Type &quot;/help vars cpvar&quot; for command usage&#39;</span><span class="s">)</span><span class="sc">;</span>
 268         <span class="k">return</span><span class="sc">;</span>
 269     <span class="s">}</span>
 270     
 271     <span class="k">unless</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$var</span>}<span class="s">)</span> <span class="s">{</span>
 272         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Error: variable &#39;$var&#39; does not exist. Cannot copy.&quot;</span><span class="s">)</span><span class="sc">;</span>
 273         <span class="k">return</span><span class="sc">;</span>
 274     <span class="s">}</span>
 275     
 276     <span class="k">my</span> <span class="i">$newvar</span> = <span class="k">shift</span><span class="s">(</span><span class="i">@args</span><span class="s">)</span><span class="sc">;</span>
 277     <span class="k">my</span> <span class="i">$tmp</span><span class="sc">;</span>
 278     <span class="k">my</span> <span class="i">$safe</span><span class="sc">;</span>
 279     <span class="k">if</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$newvar</span>}<span class="s">)</span> <span class="s">{</span>
 280         <span class="k">unless</span><span class="s">(</span><span class="i">$flags</span>[<span class="n">0</span>] <span class="k">eq</span> <span class="q">&#39;f&#39;</span><span class="s">)</span> <span class="s">{</span>
 281             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Error, &#39;$newvar&#39; already exists. Use &#39;-f&#39; flag (/cpvar -f foo bar) if you wish to overwrite.&quot;</span><span class="s">)</span><span class="sc">;</span>
 282             <span class="k">return</span><span class="sc">;</span>
 283         <span class="s">}</span>
 284         <span class="k">else</span> <span class="s">{</span>
 285             <span class="i">$tmp</span> = <span class="i">$foo</span>{<span class="i">$newvar</span>}<span class="sc">;</span>
 286             <span class="i">$safe</span> = <span class="i">loopcheck</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$var</span>}<span class="s">)</span><span class="sc">;</span>
 287             <span class="k">if</span><span class="s">(</span><span class="i">$safe</span> <span class="k">eq</span> <span class="q">&#39;ERROR&#39;</span><span class="s">)</span> <span class="s">{</span>
 288                 <span class="k">undef</span><span class="s">(</span><span class="i">$tmp</span><span class="s">)</span><span class="sc">;</span>
 289                 <span class="k">return</span><span class="sc">;</span>
 290             <span class="s">}</span>
 291             <span class="k">else</span> <span class="s">{</span>
 292                 <span class="i">$foo</span>{<span class="i">$newvar</span>} = <span class="s">(</span><span class="i">$flags</span>[<span class="n">1</span>] || <span class="i">$flags</span>[<span class="n">0</span>] <span class="k">eq</span> <span class="q">&#39;p&#39;</span><span class="s">)</span> ? <span class="i">$safe</span> <span class="co">:</span> <span class="i">$foo</span>{<span class="i">$var</span>}<span class="sc">;</span>
 293             <span class="s">}</span>
 294             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Contents of &quot;</span> . <span class="s">(</span><span class="s">(</span><span class="i">$flags</span>[<span class="n">1</span>] || <span class="i">$flags</span>[<span class="n">0</span>] <span class="k">eq</span> <span class="q">&#39;p&#39;</span><span class="s">)</span> ? <span class="q">&#39;fully expanded&#39;</span> <span class="co">:</span> <span class="q">&#39;&#39;</span><span class="s">)</span>  . <span class="q">&quot; variable &#39;$var&#39; successfully copied to existing variable &#39;$newvar&#39;.&quot;</span><span class="s">)</span><span class="sc">;</span>
 295             <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 296         <span class="s">}</span>
 297     <span class="s">}</span>
 298     <span class="k">else</span> <span class="s">{</span>
 299         <span class="i">$safe</span> = <span class="i">loopcheck</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$var</span>}<span class="s">)</span><span class="sc">;</span>
 300         <span class="k">if</span><span class="s">(</span><span class="i">$safe</span> <span class="k">eq</span> <span class="q">&#39;ERROR&#39;</span><span class="s">)</span> <span class="s">{</span>
 301             <span class="k">return</span><span class="sc">;</span>
 302         <span class="s">}</span>
 303         <span class="k">else</span> <span class="s">{</span>
 304             <span class="i">$foo</span>{<span class="i">$newvar</span>} = <span class="s">(</span><span class="i">$flags</span>[<span class="n">1</span>] || <span class="s">(</span><span class="i">$flags</span>[<span class="n">0</span>] &amp;&amp; <span class="i">$flags</span>[<span class="n">0</span>] <span class="k">eq</span> <span class="q">&#39;p&#39;</span><span class="s">)</span><span class="s">)</span> ? <span class="i">$safe</span> <span class="co">:</span> <span class="i">$foo</span>{<span class="i">$var</span>}<span class="sc">;</span>
 305         <span class="s">}</span>
 306         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;Contents of fully expanded variable &#39;$var&#39; successfully copied to new variable &#39;$newvar&#39;.&quot;</span><span class="s">)</span><span class="sc">;</span>
 307         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 308     <span class="s">}</span>
 309 
 310     <span class="c">#build undo and redo stack</span>
 311     <span class="k">if</span><span class="s">(</span><span class="i">$tmp</span><span class="s">)</span> <span class="s">{</span>
 312         <span class="k">my</span> <span class="i">$undoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 313                         <span class="i">$foo</span>{<span class="i">$newvar</span>} = <span class="i">$tmp</span><span class="sc">;</span>
 314                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 315                       <span class="s">}</span><span class="sc">;</span>
 316         <span class="k">my</span> <span class="i">$redoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 317                         <span class="i">$foo</span>{<span class="i">$newvar</span>} = <span class="i">$foo</span>{<span class="i">$var</span>}<span class="sc">;</span>
 318                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 319                       <span class="s">}</span><span class="sc">;</span>
 320         <span class="k">my</span> <span class="i">$undoTxt</span> = <span class="q">&quot;Old value of variable &#39;$newvar&#39; restored from &#39;&quot;</span>.<span class="i">$foo</span>{<span class="i">$var</span>}.<span class="q">&quot;&#39; to &#39;$tmp&#39;.&quot;</span><span class="sc">;</span>
 321         <span class="k">my</span> <span class="i">$redoTxt</span> = <span class="q">&quot;New value of variable &#39;$newvar&#39; restored from &#39;$tmp&#39; to &#39;&quot;</span>.<span class="i">$foo</span>{<span class="i">$var</span>}.<span class="q">&quot;&#39;.&quot;</span><span class="sc">;</span>
 322 
 323         <span class="i">stack_gen</span><span class="s">(</span><span class="i">$undoRef</span><span class="cm">,</span> <span class="i">$undoTxt</span><span class="cm">,</span> <span class="i">$redoRef</span><span class="cm">,</span> <span class="i">$redoTxt</span><span class="s">)</span><span class="sc">;</span>
 324     <span class="s">}</span>
 325     <span class="k">else</span> <span class="s">{</span>
 326         <span class="k">my</span> <span class="i">$undoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 327                         <span class="k">delete</span> <span class="i">$foo</span>{<span class="i">$newvar</span>}<span class="sc">;</span>
 328                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 329                       <span class="s">}</span><span class="sc">;</span>
 330         <span class="k">my</span> <span class="i">$redoRef</span> = <span class="k">sub</span> <span class="s">{</span>
 331                         <span class="i">$foo</span>{<span class="i">$newvar</span>} = <span class="i">$foo</span>{<span class="i">$var</span>}<span class="sc">;</span>
 332                         <span class="i">store</span><span class="s">(</span>\<span class="i">%foo</span><span class="cm">,</span> <span class="i">$config</span>{<span class="q">&#39;vardata_path&#39;</span>}.<span class="q">&#39;.vardata&#39;</span><span class="s">)</span><span class="sc">;</span>
 333                       <span class="s">}</span><span class="sc">;</span>
 334         <span class="k">my</span> <span class="i">$undoTxt</span> = <span class="q">&quot;Variable &#39;$newvar&#39; removed.&quot;</span><span class="sc">;</span>
 335         <span class="k">my</span> <span class="i">$redoTxt</span> = <span class="q">&quot;New variable &#39;$newvar&#39; restored with value &#39;&quot;</span>.<span class="i">$foo</span>{<span class="i">$var</span>}.<span class="q">&quot;&#39;.&quot;</span><span class="sc">;</span>
 336 
 337         <span class="i">stack_gen</span><span class="s">(</span><span class="i">$undoRef</span><span class="cm">,</span> <span class="i">$undoTxt</span><span class="cm">,</span> <span class="i">$redoRef</span><span class="cm">,</span> <span class="i">$redoTxt</span><span class="s">)</span><span class="sc">;</span>
 338     <span class="s">}</span>
 339     <span class="k">return</span><span class="sc">;</span>
 340 <span class="s">}</span>
 341 
<a name="cmd_varlist"></a> 342 <span class="k">sub </span><span class="m">cmd_varlist</span> <span class="s">{</span>
 343     <span class="k">if</span><span class="s">(</span>!<span class="i">%foo</span><span class="s">)</span> <span class="s">{</span>
 344         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;No variables found&#39;</span><span class="s">)</span><span class="sc">;</span>
 345         <span class="k">return</span><span class="sc">;</span>
 346     <span class="s">}</span>
 347     <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 348     <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;\x02\x035&quot;</span>.<span class="q">&quot;Listing all variables:&quot;</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 349     <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;\x038name\x03: &#39;value&#39; - (&#39;\x033Expanded content if available\x03&#39;)&quot;</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 350     <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;=&#39;</span> x <span class="n">49</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 351     <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="k">sort</span> <span class="s">{</span><span class="k">lc</span><span class="s">(</span><span class="i">$a</span><span class="s">)</span> <span class="k">cmp</span> <span class="k">lc</span><span class="s">(</span><span class="i">$b</span><span class="s">)</span><span class="s">}</span> <span class="k">keys</span> <span class="i">%foo</span><span class="s">)</span> <span class="s">{</span>
 352         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&quot;\x038\x02\x02$key\x03&quot;</span> . <span class="q">&#39;: \&#39;&#39;</span> . <span class="i">$foo</span>{<span class="i">$key</span>} . <span class="q">&#39;\&#39;&#39;</span> . <span class="s">(</span><span class="i">loopcheck</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$key</span>}<span class="s">)</span> <span class="k">ne</span> <span class="i">$foo</span>{<span class="i">$key</span>} ? <span class="s">(</span><span class="q">&quot; - (&#39;\x033\x02\x02&quot;</span> . <span class="i">loopcheck</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$key</span>}<span class="s">)</span> . <span class="q">&quot;\x03&#39;)&quot;</span><span class="s">)</span> <span class="co">:</span> <span class="q">&quot;&quot;</span><span class="s">)</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 353     <span class="s">}</span>
 354     <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 355 <span class="s">}</span>
 356 
<a name="cmd_undo"></a> 357 <span class="k">sub </span><span class="m">cmd_undo</span> <span class="s">{</span>
 358     <span class="k">my</span> <span class="s">(</span><span class="i">$repeat</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 359     <span class="k">unless</span><span class="s">(</span><span class="i">$repeat</span> =~ <span class="q">/^(((\s*)(\d+)(\s*))|\s*)$/</span><span class="s">)</span> <span class="s">{</span>
 360         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Error: Non-integer argument.&#39;</span><span class="s">)</span><span class="sc">;</span>
 361         <span class="k">return</span><span class="sc">;</span>
 362     <span class="s">}</span>
 363     <span class="k">if</span><span class="s">(</span>!<span class="i">@undo</span><span class="s">)</span> <span class="s">{</span>
 364         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;No tasks left in the undo buffer&#39;</span><span class="s">)</span><span class="sc">;</span>
 365         <span class="k">return</span><span class="sc">;</span>
 366     <span class="s">}</span>
 367 
 368     <span class="k">if</span><span class="s">(</span><span class="i">$4</span> &amp;&amp; <span class="i">$repeat</span> &gt; <span class="k">scalar</span><span class="s">(</span><span class="i">@undo</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
 369         <span class="i">$repeat</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@undo</span><span class="s">)</span> - <span class="n">1</span><span class="sc">;</span>
 370     <span class="s">}</span>
 371     <span class="k">elsif</span><span class="s">(</span><span class="i">$4</span><span class="s">)</span> <span class="s">{</span>
 372         <span class="i">$repeat</span> = <span class="i">$4</span> - <span class="n">1</span><span class="sc">;</span>
 373     <span class="s">}</span>
 374     <span class="k">else</span> <span class="s">{</span>
 375         <span class="i">$repeat</span> = <span class="n">0</span><span class="sc">;</span>
 376     <span class="s">}</span>
 377 
 378     <span class="k">for</span><span class="s">(</span><span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$repeat</span><span class="sc">;</span> <span class="i">$i</span>++<span class="s">)</span> <span class="s">{</span>
 379         <span class="k">my</span> <span class="i">$ref</span> = <span class="k">pop</span><span class="s">(</span><span class="i">@undo</span><span class="s">)</span><span class="sc">;</span>
 380         <span class="i">&amp;</span>{ <span class="i">@</span>{ <span class="i">@</span>{<span class="i">$ref</span>}[<span class="n">0</span>] }[<span class="n">0</span>] }<span class="sc">;</span>
 381         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Undo successful: &#39;</span> . <span class="i">@</span>{ <span class="i">@</span>{<span class="i">$ref</span>}[<span class="n">0</span>] }[<span class="n">1</span>]<span class="s">)</span><span class="sc">;</span>
 382         <span class="k">push</span><span class="s">(</span><span class="i">@redo</span><span class="cm">,</span> <span class="i">$ref</span><span class="s">)</span><span class="sc">;</span>
 383     <span class="s">}</span>
 384 <span class="s">}</span>
 385 
<a name="cmd_redo"></a> 386 <span class="k">sub </span><span class="m">cmd_redo</span> <span class="s">{</span>
 387     <span class="k">my</span> <span class="s">(</span><span class="i">$repeat</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 388     <span class="k">if</span><span class="s">(</span><span class="i">$repeat</span> !~ <span class="q">/^(((\s*)(\d+)(\s*))|\s*)$/</span><span class="s">)</span> <span class="s">{</span>
 389         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Error: Non-integer argument.&#39;</span><span class="s">)</span><span class="sc">;</span>
 390         <span class="k">return</span><span class="sc">;</span>
 391     <span class="s">}</span>
 392     <span class="k">if</span><span class="s">(</span>!<span class="i">@redo</span><span class="s">)</span> <span class="s">{</span>
 393         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;No tasks left in the redo buffer&#39;</span><span class="s">)</span><span class="sc">;</span>
 394         <span class="k">return</span><span class="sc">;</span>
 395     <span class="s">}</span>
 396 
 397     <span class="k">if</span><span class="s">(</span><span class="i">$4</span> &amp;&amp; <span class="i">$repeat</span> &gt; <span class="k">scalar</span><span class="s">(</span><span class="i">@redo</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
 398         <span class="i">$repeat</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@redo</span><span class="s">)</span> - <span class="n">1</span><span class="sc">;</span>
 399     <span class="s">}</span>
 400     <span class="k">elsif</span><span class="s">(</span><span class="i">$4</span><span class="s">)</span> <span class="s">{</span>
 401         <span class="i">$repeat</span> = <span class="i">$4</span> - <span class="n">1</span><span class="sc">;</span>
 402     <span class="s">}</span>
 403     <span class="k">else</span> <span class="s">{</span>
 404         <span class="i">$repeat</span> = <span class="n">0</span><span class="sc">;</span>
 405     <span class="s">}</span>
 406 
 407     <span class="k">for</span><span class="s">(</span><span class="k">my</span> <span class="i">$i</span> = <span class="n">0</span><span class="sc">;</span> <span class="i">$i</span> &lt;= <span class="i">$repeat</span><span class="sc">;</span> <span class="i">$i</span>++<span class="s">)</span> <span class="s">{</span>
 408         <span class="k">my</span> <span class="i">$ref</span> = <span class="k">pop</span><span class="s">(</span><span class="i">@redo</span><span class="s">)</span><span class="sc">;</span>
 409         <span class="i">&amp;</span>{ <span class="i">@</span>{ <span class="i">@</span>{<span class="i">$ref</span>}[<span class="n">1</span>] }[<span class="n">0</span>] }<span class="sc">;</span>
 410         <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Redo successful: &#39;</span> . <span class="i">@</span>{ <span class="i">@</span>{<span class="i">$ref</span>}[<span class="n">1</span>] }[<span class="n">1</span>]<span class="s">)</span><span class="sc">;</span>
 411         <span class="k">push</span><span class="s">(</span><span class="i">@undo</span><span class="cm">,</span> <span class="i">$ref</span><span class="s">)</span><span class="sc">;</span>
 412     <span class="s">}</span>
 413 <span class="s">}</span>
 414 
<a name="varreplace"></a> 415 <span class="k">sub </span><span class="m">varreplace</span> <span class="s">{</span>
 416     <span class="k">return</span> <span class="k">if</span> <span class="k">not</span> <span class="i">%foo</span><span class="sc">;</span>
 417     <span class="k">my</span> <span class="s">(</span><span class="i">$data</span><span class="cm">,</span> <span class="i">$server</span><span class="cm">,</span> <span class="i">$witem</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 418     <span class="c">#my $emit = Irssi::signal_get_emitted();</span>
 419     <span class="c">#Irssi::print($emit);</span>
 420     <span class="c">#Irssi::print(&quot;data in varreplace sub: $data&quot;);</span>
 421     <span class="k">if</span><span class="s">(</span><span class="i">$data</span> =~ <span class="q">/^\/(.*?)\s/</span><span class="s">)</span> <span class="s">{</span>
 422         <span class="k">my</span> <span class="i">@matches</span> = <span class="k">grep</span><span class="s">(</span><span class="q">/$1/</span><span class="cm">,</span> <span class="i">@varcmds</span><span class="s">)</span><span class="sc">;</span>
 423         <span class="c">#Irssi::print(join(&#39;, &#39;, @matches));</span>
 424         <span class="k">if</span><span class="s">(</span><span class="i">@matches</span><span class="s">)</span> <span class="s">{</span>
 425             <span class="c">#Irssi::print(&quot;$1 is a varcmd&quot;);</span>
 426             <span class="k">return</span><span class="sc">;</span>
 427         <span class="s">}</span>
 428     <span class="s">}</span>
 429     <span class="k">return</span> <span class="k">if</span> <span class="s">(</span>!<span class="i">$server</span> || !<span class="i">$server</span>-&gt;{<span class="w">connected</span>}<span class="s">)</span><span class="sc">;</span>
 430     <span class="k">if</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> <span class="s">{</span>
 431         <span class="c">#Irssi::print(&quot;about to init loopcheck&quot;);</span>
 432         <span class="i">$data</span> = <span class="i">loopcheck</span><span class="s">(</span><span class="i">$data</span><span class="s">)</span><span class="sc">;</span>
 433         <span class="c">#Irssi::print(&quot;loopcheck fin - data = $data&quot;);</span>
 434         <span class="k">if</span><span class="s">(</span><span class="i">$data</span> <span class="k">ne</span> <span class="q">&#39;ERROR&#39;</span><span class="s">)</span> <span class="s">{</span>
 435             <span class="i">$data</span> =~ <span class="q">s/\\\{\{/{{/g</span><span class="sc">;</span>
 436             <span class="i">$data</span> =~ <span class="q">s/\\\}\}/}}/g</span><span class="sc">;</span>
 437             <span class="i">Irssi::signal_continue</span><span class="s">(</span><span class="i">$data</span><span class="cm">,</span> <span class="i">$server</span><span class="cm">,</span> <span class="i">$witem</span><span class="s">)</span><span class="sc">;</span>
 438         <span class="s">}</span>
 439         <span class="k">else</span> <span class="s">{</span>
 440             <span class="i">Irssi::signal_stop</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
 441         <span class="s">}</span>
 442     <span class="s">}</span>
 443     <span class="k">return</span><span class="sc">;</span>
 444 <span class="s">}</span>
 445 
<a name="loopcheck"></a> 446 <span class="k">sub </span><span class="m">loopcheck</span> <span class="s">{</span>
 447     <span class="k">my</span> <span class="s">(</span><span class="i">$data</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
 448     <span class="c">#Irssi::print(&quot;data: $data&quot;);</span>
 449     <span class="k">my</span> <span class="i">@loop</span><span class="sc">;</span>
 450     <span class="k">while</span><span class="s">(</span><span class="i">$data</span> =~ <span class="q">/(?!\\)\{\{(\w+)(?!\\)\}\}/</span><span class="s">)</span> <span class="s">{</span>
 451         <span class="c">#Irssi::print(&quot;why am I here? - pre: $`; match: $&amp;; post: $&#39;&quot;);</span>
 452         <span class="k">my</span> <span class="i">$var</span> = <span class="i">$1</span><span class="sc">;</span>
 453     
 454         <span class="c">#first, we ensure the variable exists in the first place.</span>
 455         <span class="k">unless</span><span class="s">(</span><span class="i">$foo</span>{<span class="i">$var</span>}<span class="s">)</span> <span class="s">{</span>
 456             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Inserted variable \&#39;{{&#39;</span> . <span class="i">$var</span> . <span class="q">&#39;}}\&#39; does not exist. Remember to backlslash (\{{ \}}) any variables you do not want interpreted. Supressed.&#39;</span><span class="s">)</span><span class="sc">;</span>
 457             <span class="k">return</span> <span class="q">&#39;ERROR&#39;</span><span class="sc">;</span>
 458         <span class="s">}</span>
 459 
 460         <span class="c">#Now, we start making sure that there aren&#39;t any silly loops and such occurring, e.g. {{foo}} = {{bar}} and {{bar}} = {{foo}}.</span>
 461         <span class="k">if</span><span class="s">(</span>!<span class="k">grep</span><span class="s">(</span><span class="q">/^$var$/</span><span class="cm">,</span> <span class="i">@loop</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
 462             <span class="k">push</span><span class="s">(</span><span class="i">@loop</span><span class="cm">,</span> <span class="i">$var</span><span class="s">)</span><span class="sc">;</span>
 463             <span class="i">$data</span> =~ <span class="q">s/\{\{$var\}\}/$foo{$var}/e</span><span class="sc">;</span>
 464         <span class="s">}</span>
 465         <span class="k">else</span> <span class="s">{</span>
 466             <span class="c">#Yep, someone is being an idiot... Double slap them if this is an IRC event, since they&#39;ve manually changed the contents of %foo</span>
 467             <span class="i">Irssi::print</span><span class="s">(</span><span class="q">&#39;Loop detected in variable \&#39;&#39;</span> . <span class="i">$var</span> . <span class="q">&#39;\&#39;&#39;</span><span class="s">)</span><span class="sc">;</span>
 468             <span class="k">return</span> <span class="q">&#39;ERROR&#39;</span><span class="sc">;</span>
 469         <span class="s">}</span>
 470         <span class="c">#now we clear out the loop, ready for the next variable (if any) to be checked</span>
 471         <span class="i">@loop</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
 472     <span class="s">}</span>
 473         <span class="c">#Irssi::print(&quot;After loop: data = $data&quot;);</span>
 474 	<span class="k">return</span> <span class="i">$data</span><span class="sc">;</span>
 475 <span class="s">}</span>
 476 
<a name="cmd_help"></a> 477 <span class="k">sub </span><span class="m">cmd_help</span> <span class="s">{</span>
 478     <span class="k">my</span> <span class="i">$help</span> = <span class="q">&quot;For help on a specific command, e.g. /mkvar, type /help varspl mkvar.\n&quot;</span>
 479              . <span class="q">&quot;This help is also available online at: http://users.aber.ac.uk/ord8/tech/non-web/varspl/?commands&quot;</span><span class="sc">;</span>
 480     <span class="k">if</span> <span class="s">(</span><span class="i">$_</span>[<span class="n">0</span>] <span class="k">eq</span> <span class="q">&#39;varspl&#39;</span><span class="s">)</span> <span class="s">{</span>
 481         <span class="i">Irssi::print</span><span class="s">(</span><span class="i">$help</span><span class="cm">,</span> <span class="w">MSGLEVEL_MSGS</span><span class="s">)</span><span class="sc">;</span>
 482         <span class="w">Irssi::signal_stop</span><span class="sc">;</span>
 483     <span class="s">}</span>
 484     <span class="k">elsif</span> <span class="s">(</span><span class="i">$_</span>[<span class="n">0</span>] =~ <span class="q">/^vars (\w+)$/</span><span class="s">)</span> <span class="s">{</span>
 485         <span class="k">if</span><span class="s">(</span><span class="k">exists</span> <span class="i">&amp;</span>{<span class="q">&#39;help_&#39;</span> . <span class="k">lc</span><span class="s">(</span><span class="i">$1</span><span class="s">)</span>}<span class="s">)</span> <span class="s">{</span>
 486             <span class="k">foreach</span><span class="s">(</span><span class="i">&amp;</span>{\<span class="i">&amp;</span>{<span class="q">&#39;help_&#39;</span> . <span class="k">lc</span><span class="s">(</span><span class="i">$1</span><span class="s">)</span>}}<span class="s">(</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
 487                 <span class="i">Irssi::print</span><span class="s">(</span><span class="i">$_</span><span class="cm">,</span> <span class="w">MSGLEVEL_CLIENTCRAP</span><span class="s">)</span><span class="sc">;</span>
 488             <span class="s">}</span>
 489             <span class="w">Irssi::signal_stop</span><span class="sc">;</span>
 490         <span class="s">}</span>
 491     <span class="s">}</span>
 492 <span class="s">}</span>
 493 
<a name="help_mkvar"></a> 494 <span class="k">sub </span><span class="m">help_mkvar</span> <span class="s">{</span>
 495     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 496                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 497                      <span class="q">&quot;Synopsis: /mkvar name value&quot;</span><span class="cm">,</span>
 498                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 499                      <span class="q">&quot;This is the most important part of vars.pl, since this allows you to create all of your variables, &quot;</span>
 500                     .<span class="q">&quot;which can be to insert something useful, such as an oft-used weird character that&#39;s difficult to type, &quot;</span>
 501                     .<span class="q">&quot;or something silly and hilarious, or... well, whatever you feel like shoving into a variable, really.&quot;</span><span class="cm">,</span>
 502                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 503                      <span class="q">&quot;Usage:&quot;</span><span class="cm">,</span>
 504                      <span class="q">&quot;Lets say you wanted to create our friendly &#39;foo&#39; variable, and wanted to set its value to &#39;morning&#39;, &quot;</span>
 505                     .<span class="q">&quot;as in the example above, you would simply type the command &#39;/mkvar foo morning&#39;, and press Enter/Return. &quot;</span>
 506                     .<span class="q">&quot;That&#39;s it! Done. It really is that easy.&quot;</span><span class="cm">,</span>
 507                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 508                      <span class="q">&quot;The way the command is parsed by the script is quite simple. /mkvar [name] [everything else]. &quot;</span>
 509                     .<span class="q">&quot;The name must be made up of only &#39;word&#39; characters, i.e. a-z, A-Z, 0-9 or _. If you insert a space, &quot;</span>
 510                     .<span class="q">&quot;you terminate the variable name. Everything after the space is considered to be the value you wish to store &quot;</span>
 511                     .<span class="q">&quot;in the variable. This means that, for example; you cannot create a variable called &#39;my mobile number&#39; and &quot;</span>
 512                     .<span class="q">&quot;insert the value &#39;07#########&#39;. Typing &#39;/mkvar my mobile number 07#########&#39; will result in a variable called &quot;</span>
 513                     .<span class="q">&quot;&#39;my&#39; being created, which contains the value &#39;mobile number 07#########&#39;. The value stored in the variable &quot;</span>
 514                     .<span class="q">&quot;can be absolutely anything. If it&#39;s a typeable character, you can put it in. Note, however, that sequences &quot;</span>
 515                     .<span class="q">&quot;such as &#39;\\n&#39; are interpreted literally, and will not insert a newline character into your variable. &quot;</span>
 516                     .<span class="q">&quot;Attempting to insert an actual newline character will result in irssi&#39;s usual behaviour, which is to send &quot;</span>
 517                     .<span class="q">&quot;the message off for processing, meaning that the intended value of your variable may be cut short.&quot;</span><span class="cm">,</span>
 518                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 519                      <span class="q">&quot;Now lets step up the game a little... If I found that greeting people was becoming tedious, and that typing &quot;</span>
 520                     .<span class="q">&quot;Good {{foo}}! was too much like hard work, I could simply make it all into a variable by typing the command &quot;</span>
 521                     .<span class="q">&quot;&#39;/mkvar greet Good {{foo}}!&#39;. Here&#39;s the slightly tricky bit, so pay attention: because of the way I &quot;</span>
 522                     .<span class="q">&quot;designed this script, {{foo}} does not get converted into &#39;morning&#39; when creating, or editing &quot;</span>
 523                     .<span class="q">&quot;(see /editvar) variables. It does, however, become expanded when {{greet}} is used anywhere else. If I &quot;</span>
 524                     .<span class="q">&quot;type {{greet}} into my input buffer and press return, the script first expands {{greet}} to &#39;Good {{foo}}!&#39;&quot;</span>
 525                     .<span class="q">&quot;, and then looks up the value of {{foo}} and expands that, which results in &#39;Good morning!&#39; being sent &quot;</span>
 526                     .<span class="q">&quot;into the irssi core for the usual processing. However, as morning changes to afternoon, your greeting &quot;</span>
 527                     .<span class="q">&quot;becomes less and less appropriate, so if you were to later change the value of &#39;foo&#39; to &#39;afternoon&#39;, &quot;</span>
 528                     .<span class="q">&quot;sending {{greet}} would now output &#39;Good afternoon!&#39;.&quot;</span><span class="cm">,</span>
 529                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 530                      <span class="q">&quot;If you attempt to create a variable with the same name as one that already exists in the system, &quot;</span>
 531                     .<span class="q">&quot;the script will present an error message in your status window, explaining that the chosen name already &quot;</span>
 532                     .<span class="q">&quot;exists, and that you should make use of the /editvar command if you wish to overwrite the current value &quot;</span>
 533                     .<span class="q">&quot;of that variable.&quot;</span><span class="cm">,</span>
 534                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 535                 <span class="s">)</span><span class="sc">;</span>
 536     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 537 <span class="s">}</span>
<a name="help_rmvar"></a> 538 <span class="k">sub </span><span class="m">help_rmvar</span> <span class="s">{</span>
 539     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 540                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 541                      <span class="q">&quot;Synopsis: /rmvar variable&quot;</span><span class="cm">,</span>
 542                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 543                      <span class="q">&quot;This command should be fairly obvious. It is used to remove any variables which are no longer &quot;</span>
 544                     .<span class="q">&quot;required, or which you added by accident. (For more on accidents, see /undo)&quot;</span><span class="cm">,</span>
 545                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 546                      <span class="q">&quot;Only thing left that&#39;s worth mentioning about this command, is that it will generate an error &quot;</span>
 547                     .<span class="q">&quot;if you attempt to remove a variable that doesn&#39;t exist. Once the variable has been deleted, you &quot;</span>
 548                     .<span class="q">&quot;cannot use it, or view it in the list of variables (see /varlist). This does not automatically &quot;</span>
 549                     .<span class="q">&quot;mean that it is gone forever. It will be in your undo buffer until the script is unloaded, either &quot;</span>
 550                     .<span class="q">&quot;manually using /script unload vars or forcibly via irssi terminating. If irssi terminates for &quot;</span>
 551                     .<span class="q">&quot;whatever reason, I&#39;m sorry, you can&#39;t get it back. You will have to recreate it again yourself, &quot;</span>
 552                     .<span class="q">&quot;like you did the first time around (see /mkvar).&quot;</span><span class="cm">,</span>
 553                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 554                      <span class="q">&quot;TODO: decide on appropriate behaviour when a user removes a variable that another variable depended upon.&quot;</span><span class="cm">,</span>
 555                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 556                 <span class="s">)</span><span class="sc">;</span>
 557     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 558 <span class="s">}</span>
<a name="help_editvar"></a> 559 <span class="k">sub </span><span class="m">help_editvar</span> <span class="s">{</span>
 560     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 561                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 562                      <span class="q">&quot;Synopsis: /editvar variable new-value&quot;</span><span class="cm">,</span>
 563                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 564                      <span class="q">&quot;This variable works in almost exactly the same way as /mkvar. The only difference is the treatment of &quot;</span>
 565                     .<span class="q">&quot;variables that do/don&#39;t exist. /mkvar will complain if you try to create a variable that already exists, &quot;</span>
 566                     .<span class="q">&quot;whereas this command will complain if you try to edit the value of a command that doesn&#39;t exist. &quot;</span>
 567                     .<span class="q">&quot;Tab-completion is supported by this command, so you can easily fill out the names of existing variables &quot;</span>
 568                     .<span class="q">&quot;to avoid the script laughing at your futile efforts to not typo a name.&quot;</span><span class="cm">,</span>
 569                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 570                      <span class="q">&quot;Don&#39;t try any funny business. By \&quot;funny\&quot;, I mean, for example, creating a variable called &#39;foo&#39;, then &quot;</span>
 571                     .<span class="q">&quot;creating a variable called &#39;bar&#39; which contains &#39;{{foo}}&#39;, and then trying /editvar foo {{bar}}. &quot;</span>
 572                     .<span class="q">&quot;vars.pl will see what you are doing and put its metaphorical foot down.&quot;</span><span class="cm">,</span>
 573                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 574                      <span class="q">&quot;Oh, and for those of you trying to be clever and making &#39;foo&#39; contain {{bar}}, which contains {{baz}} &quot;</span>
 575                     .<span class="q">&quot;which contains {{this}}, which contains {{that}} which contains ... etc, etc ... which contains &quot;</span>
 576                     .<span class="q">&quot;{{foo}} - that won&#39;t work either. vars.pl will quite happily plough through as many levels of depth &quot;</span>
 577                     .<span class="q">&quot;as you care to create, detect your loop, and ridicule you, making you the laughing stock of all of &quot;</span>
 578                     .<span class="q">&quot;your imaginary internet friends.&quot;</span><span class="cm">,</span>
 579                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 580                 <span class="s">)</span><span class="sc">;</span>
 581     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 582 <span class="s">}</span>
<a name="help_cpvar"></a> 583 <span class="k">sub </span><span class="m">help_cpvar</span> <span class="s">{</span>
 584     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 585                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 586                      <span class="q">&quot;Synopsis: /cpvar [-fp] variable name&quot;</span><span class="cm">,</span>
 587                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 588                      <span class="q">&quot;This is a fun one. Essentially, what this command does, is copies the value of an existing variable, &quot;</span>
 589                     .<span class="q">&quot;into another variable. Using /cpvar as-is, is intended to make a copy of the value of the provided &quot;</span>
 590                     .<span class="q">&quot;variable name, and place it in a new variable, which you name in the second argument. If you wish to &quot;</span>
 591                     .<span class="q">&quot;copy the contents of one variable into another variable which already exists, then you must provide &quot;</span>
 592                     .<span class="q">&quot;the &#39;-f&#39; flag, i.e. /cpvar -f foo bar.&quot;</span><span class="cm">,</span>
 593                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 594                      <span class="q">&quot;Note that any inserted variables that are contained in the variable being copied will be copied &quot;</span>
 595                     .<span class="q">&quot;over as well, without being inflated. This means that say, if you had a variable called &#39;foo&#39;, &quot;</span>
 596                     .<span class="q">&quot;which was used in &#39;bar&#39;, then if you copy the contents of &#39;bar&#39; to &#39;baz&#39;, then &#39;baz&#39; will also &quot;</span>
 597                     .<span class="q">&quot;depend on &#39;foo&#39;.&quot;</span><span class="cm">,</span>
 598                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 599                      <span class="q">&quot;Similarly to /editvar, any pathetic attempts to create loops of any depth will be met with scorn.&quot;</span><span class="cm">,</span>
 600                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 601                      <span class="q">&quot;Adding the -p flag (p for &#39;preserve&#39;) will allow one to copy the inflated values of a &quot;</span>
 602                     .<span class="q">&quot;contained variable, such that later editing contained variables does not alter the value &quot;</span>
 603                     .<span class="q">&quot;of the copied variable.&quot;</span><span class="cm">,</span>
 604                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 605                 <span class="s">)</span><span class="sc">;</span>
 606     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 607 <span class="s">}</span>
<a name="help_varlist"></a> 608 <span class="k">sub </span><span class="m">help_varlist</span> <span class="s">{</span>
 609     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 610                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 611                      <span class="q">&quot;Synopsis: /varlist&quot;</span><span class="cm">,</span>
 612                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 613                      <span class="q">&quot;This command takes no arguments (yet) and prints a list of all the variables you have saved. Simple.&quot;</span><span class="cm">,</span>
 614                      <span class="q">&quot;TODO: maybe allow an optional argument to print all variables that match a given pattern.&quot;</span><span class="cm">,</span>
 615                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 616                 <span class="s">)</span><span class="sc">;</span>
 617     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 618 <span class="s">}</span>
<a name="help_undo"></a> 619 <span class="k">sub </span><span class="m">help_undo</span> <span class="s">{</span>
 620     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 621                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 622                      <span class="q">&quot;Synopsis: /undo [#]&quot;</span><span class="cm">,</span>
 623                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 624                      <span class="q">&quot;This command does exactly what it says on the tin. It will revert the last action that you completed &quot;</span>
 625                     .<span class="q">&quot;through vars.pl services. Undoing an action will create an item in the redo buffer (see /redo).&quot;</span><span class="cm">,</span>
 626                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 627                      <span class="q">&quot;The command takes an optional integer argument, which will specify the number of steps to undo.&quot;</span><span class="cm">,</span>
 628                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 629                 <span class="s">)</span><span class="sc">;</span>
 630     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 631 <span class="s">}</span>
<a name="help_redo"></a> 632 <span class="k">sub </span><span class="m">help_redo</span> <span class="s">{</span>
 633     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 634                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 635                      <span class="q">&quot;Synopsis: /redo [#]&quot;</span><span class="cm">,</span>
 636                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 637                      <span class="q">&quot;Another self explanatory command. This one lets you redo any actions that you may have &quot;</span>
 638                     .<span class="q">&quot;undone using /undo. Redoing an action will create an item in the undo buffer.&quot;</span><span class="cm">,</span>
 639                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 640                      <span class="q">&quot;Note that whenever a new action is completed (i.e. not an action from the undo buffer), &quot;</span>
 641                     .<span class="q">&quot;the redo buffer is compeltely cleared out.&quot;</span><span class="cm">,</span>
 642                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 643                      <span class="q">&quot;The command takes an optional integer argument, to specify number of steps to redo.&quot;</span><span class="cm">,</span>
 644                      <span class="q">&quot;&quot;</span><span class="cm">,</span>
 645                 <span class="s">)</span><span class="sc">;</span>
 646     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 647 <span class="s">}</span>
<a name="help_help"></a> 648 <span class="k">sub </span><span class="m">help_help</span> <span class="s">{</span>
 649     <span class="k">my</span> <span class="i">@help</span> = <span class="s">(</span>
 650                     <span class="q">&quot;&quot;</span><span class="cm">,</span>
 651                     <span class="q">&quot;Synopsis: /help&quot;</span><span class="cm">,</span>
 652                     <span class="q">&quot;&quot;</span><span class="cm">,</span>
 653                     <span class="q">&quot;Well you obviously know how this works... Substitue &#39;help&#39; (not /help) with a subject, e.g. &#39;mkvar&#39;.&quot;</span><span class="cm">,</span>
 654                     <span class="q">&quot;&quot;</span><span class="cm">,</span>
 655                 <span class="s">)</span><span class="sc">;</span>
 656     <span class="k">return</span> <span class="i">@help</span><span class="sc">;</span>
 657 <span class="s">}</span>
 658 
 659 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;mkvar&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_mkvar&#39;</span><span class="s">)</span><span class="sc">;</span>
 660 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;rmvar&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_rmvar&#39;</span><span class="s">)</span><span class="sc">;</span>
 661 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;editvar&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_editvar&#39;</span><span class="s">)</span><span class="sc">;</span>
 662 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;cpvar&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_cpvar&#39;</span><span class="s">)</span><span class="sc">;</span>
 663 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;help&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_help&#39;</span><span class="s">)</span><span class="sc">;</span>
 664 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;varlist&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_varlist&#39;</span><span class="s">)</span><span class="sc">;</span>
 665 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;undo&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_undo&#39;</span><span class="s">)</span><span class="sc">;</span>
 666 <span class="i">Irssi::command_bind</span><span class="s">(</span><span class="q">&#39;redo&#39;</span><span class="cm">,</span> <span class="q">&#39;cmd_redo&#39;</span><span class="s">)</span><span class="sc">;</span>
 667 <span class="c">#Irssi::signal_add(&#39;send text&#39;, &#39;varreplace&#39;);</span>
 668 <span class="i">Irssi::signal_add</span><span class="s">(</span><span class="q">&#39;send command&#39;</span><span class="cm">,</span> <span class="q">&#39;varreplace&#39;</span><span class="s">)</span><span class="sc">;</span>
 669 <span class="i">Irssi::signal_add_first</span><span class="s">(</span><span class="q">&quot;complete word&quot;</span><span class="cm">,</span> <span class="q">&#39;tab_complete&#39;</span><span class="s">)</span><span class="sc">;</span>
</pre>
